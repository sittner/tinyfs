#include "term.h"

#include <stdlib.h>

// do not warn about missing return value on assembler functions
#pragma disable_warning 59
#pragma disable_warning 85

#define PRINT_A_RST 0x10

static volatile uint8_t   __at 0x4027 DEBOUNCE;
static volatile uint8_t * __at 0x400C D_FILE;
static volatile uint16_t  __at 0x4025 LAST_K;

// table mapping ascii (7-bit) to ZX81 char set
static const uint8_t ascii2zx[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x76, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x0b, 0x0c, 0x0d, 0x00, 0x00, 0x0b,
  0x10, 0x11, 0x17, 0x15, 0x1a, 0x16, 0x1b, 0x18,
  0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, 0x22, 0x23,
  0x24, 0x25, 0x0e, 0x19, 0x13, 0x14, 0x12, 0x0f,
  0x17, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c,
  0x2d, 0x2e, 0x2f, 0x30, 0x31, 0x32, 0x33, 0x34,
  0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 0x3c,
  0x3d, 0x3e, 0x3f, 0x10, 0x18, 0x11, 0x0b, 0x16,
  0x0b, 0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c,
  0x2d, 0x2e, 0x2f, 0x30, 0x31, 0x32, 0x33, 0x34,
  0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 0x3c,
  0x3d, 0x3e, 0x3f, 0x10, 0x18, 0x11, 0x0b, 0x00
};

static const char zx2ascii[] =
  "           \"@$:?" //   0 -  15
  "()><=+-*/;,.0123"  //  16 -  31
  "456789abcdefghij"  //  32 -  47
  "klmnopqrstuvwxyz"  //  48 -  63
  "                "  //  64 -  79
  "                "  //  80 -  95
  "                "  //  96 - 111
  "                "; // 112 - 127

char term_buf[TERM_BUFFER_SIZE];

void term_clrscrn() {
__asm
  call _ROM_CLS
__endasm;
}

void term_putc(char c) {
__asm
  ; convert ASCII to ZX81 charset
  ld c, 4(ix)
  res 7, c
  ld b, #0x00
  ld hl, #_ascii2zx
  add hl, bc
  ld a, (hl)

  rst #PRINT_A_RST
__endasm;
}

void term_puts(const char *s) {
  term_putsn(s, 32);
}

void term_putsn(const char *s, uint8_t max_len) {
  for (; *s != 0 && max_len > 0; s++, max_len--) {
    term_putc(*s);
  }
}

void term_putul(uint32_t v) {
  term_putul_aligned(v, 0);
}

void term_putul_aligned(uint32_t v, uint8_t size) {
  char *p = term_buf + TERM_BUFFER_SIZE;
  uint8_t len = 0;
  *(--p) = 0;

  do {
    *(--p) = '0' + (v % 10);
    v /= 10;
    len++;
  } while (v);

  while (len < size) {
    *(--p) = ' ';
    len++;
  }

  term_puts(p);
}

uint16_t term_get_key(void) {
__asm
  ld a, #0xff
  ld (_DEBOUNCE), a
  call _ROM_DISPLAY_1
  ld hl,(_LAST_K)
__endasm;
}

void term_zx2ascii(const uint8_t *in) {
  uint8_t i;
  char *out;

  for (i = 0, out = term_buf; i < (TERM_BUFFER_SIZE - 1); i++, in++) {
    *(out++) = zx2ascii[*in & 0x7f];
    if (*in & 0x80) {
      break;
    }
  }

  *out = 0;
}

